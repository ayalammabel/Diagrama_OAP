<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organigramas OAP – Antes / Después</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    :root{ --accent:#16a34a; }            /* se cambia por modo */
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fff}
    header{padding:16px 20px;border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:10}
    h1{font-size:1.25rem;margin:0 0 6px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .hint{color:#555}
    select,button{
      padding:8px 10px;border:1px solid #d6d9de;background:#fafafa;border-radius:8px;cursor:pointer
    }
    button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    #network{height:80vh}

    /* Modos */
    body.mode-antes{ --accent:#2b6cb0; }   /* azul */
    body.mode-despues{ --accent:#16a34a; } /* verde */
  </style>
</head>
<body class="mode-despues">
  <header>
    <div class="row">
      <h1 id="title">Organigramas – OAP</h1>
      <label>
        Equipo:
        <select id="teamSelect"></select>
      </label>
      <button id="btnAntes">Ver ANTES</button>
      <button id="btnDespues" class="active">Ver DESPUÉS</button>
    </div>
    <div class="hint">
      Clic en la <b>raíz</b> para plegar/desplegar roles. Clic en un <b>rol</b> para ver/ocultar la persona (y subroles).<br/>
      En <b>OAP</b>, clic en un equipo abre su subdiagrama.
    </div>
  </header>

  <div id="network"></div>

  <script>
    /* ========= PARÁMETROS ========= */
    const TEAMS = ["oap", "4p", "gestion_conocimiento", "administrativo", "ti", "mipg"];
    const TEAM_LABELS = {
      oap: "OAP General",
      "4p": "4P",
      gestion_conocimiento: "Gestión del Conocimiento",
      administrativo: "Administrativo",
      ti: "TI",
      mipg: "MIPG"
    };
    let currentKey = "oap";

    // Niveles fijos
    const LVL_ROOT = 0, LVL_ROLE = 1, LVL_CHILD = 2;

    /* ========= ESTADO ========= */
    let orgBefore = null;
    let orgAfter  = null;
    let MODE = "DESPUES";   // "ANTES" | "DESPUES"

    /* ========= VIS-NETWORK ========= */
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    const container = document.getElementById("network");

    const EDGE_COLOR = '#cbd5e1'; // gris suave para todas las líneas

    const options = {
      layout: { hierarchical: { enabled:true, direction:"UD", levelSeparation:120, nodeSpacing:180, parentCentralization:true } },
      physics:false,
      nodes:{ shape:"box", margin:10, borderWidth:1, color:{ background:"#fff", border:"#9aa3af" } },

      /* 👇 Líneas con “codos” (ortogonales) */
      edges:{
        color:{ color: EDGE_COLOR },
        smooth: { enabled:true, type:"horizontal", roundness:0.15 }
        // Si quieres punticas (flechas), descomenta:
        // , arrows:{ to:{ enabled:true, scaleFactor:0.6 } }
      },

      interaction:{ hover:true, selectable:true }
    };
    const network = new vis.Network(container, { nodes, edges }, options);

    // estados de expansión
    const expandedRoot  = new Set();
    const openedPersons = new Set();
    const openedSubroles = new Set();

    /* ========= HELPERS ========= */
    const accent = ()=> getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#16a34a';

    function cleanLabel(lbl){
      if(!lbl) return '';
      return lbl
        .replace(/\s*[-–]\s*(ANTES|DESPUÉS)\s*$/i,'')
        .replace(/\s*\((ANTES|DESPUÉS)\)\s*$/i,'')
        .trim();
    }

    function applyTheme(){
      document.getElementById("btnAntes").classList.toggle('active', MODE==="ANTES");
      document.getElementById("btnDespues").classList.toggle('active', MODE==="DESPUÉS" || MODE==="DESPUES");
      if (MODE === "ANTES"){
        document.body.classList.add('mode-antes');
        document.body.classList.remove('mode-despues');
      } else {
        document.body.classList.add('mode-despues');
        document.body.classList.remove('mode-antes');
      }
    }

    function clearAll(){
      nodes.clear(); edges.clear();
      expandedRoot.clear(); openedPersons.clear(); openedSubroles.clear();
    }
    function mountRoot(root){
      nodes.add({ id: root.id, label: cleanLabel(root.label), shape:"box", level: LVL_ROOT,
                  color:{ background:"#fff", border: accent() }, borderWidth:2 });
    }
    function addRoles(root, roles){
      roles.forEach(r=>{
        if(!nodes.get(r.id)) nodes.add({ id:r.id, label:r.name, shape:"box", level: LVL_ROLE });
        if(!edges.get(`${root.id}-${r.id}`)) edges.add({ id:`${root.id}-${r.id}`, from:root.id, to:r.id, color:{ color: EDGE_COLOR } });
      });
      expandedRoot.add(root.id);
    }
    function removeRoles(root, roles){
      roles.forEach(r=>{
        const pid = `${r.id}_P`;
        if(openedPersons.has(pid)){ try{nodes.remove(pid); edges.remove(`${r.id}-${pid}`);}catch{} openedPersons.delete(pid); }
        closeSubroles(r.id);
        try{ edges.remove(`${root.id}-${r.id}`);}catch{}
        try{ nodes.remove(r.id);}catch{}
      });
      expandedRoot.delete(root.id);
    }
    function toggleRoot(root, roles){
      if(expandedRoot.has(root.id)) removeRoles(root, roles);
      else addRoles(root, roles);
      setTimeout(()=>network.fit({animation:{duration:250}}), 0);
    }

    // Personas (nivel 2). Si no hay persona, no se crea nodo.
    function togglePerson(role){
      if (!role.person || !role.person.trim()) return;
      const pid = `${role.id}_P`;
      if (openedPersons.has(pid)){
        try{nodes.remove(pid); edges.remove(`${role.id}-${pid}`);}catch{}
        openedPersons.delete(pid);
      } else {
        const nodeOptions = { id: pid, label: role.person.trim(), shape: "box", font: { italics: true }, level: LVL_CHILD };
        if (role.planta) nodeOptions.color = { background: "#efe9ff", border: "#7a5cff" };
        nodes.add(nodeOptions);
        edges.add({ id:`${role.id}-${pid}`, from:role.id, to:pid, color:{ color: EDGE_COLOR } });
        openedPersons.add(pid);
      }
    }

    function toggleSubroles(roleId, arr){
      if(!arr || !arr.length) return;
      if(openedSubroles.has(roleId)){
        arr.forEach(sr=>{ try{nodes.remove(sr.id); edges.remove(`${roleId}-${sr.id}`);}catch{} });
        openedSubroles.delete(roleId);
      }else{
        arr.forEach(sr=>{
          if(!nodes.get(sr.id)) nodes.add({ id:sr.id, label:sr.name, shape:"box", level: LVL_CHILD });
          if(!edges.get(`${roleId}-${sr.id}`)) edges.add({ id:`${roleId}-${sr.id}`, from:roleId, to:sr.id, color:{ color: EDGE_COLOR } });
        });
        openedSubroles.add(roleId);
      }
    }
    function closeSubroles(roleId){
      const arr = orgAfter?.subroles?.[roleId];
      if(!arr || !openedSubroles.has(roleId)) return;
      arr.forEach(sr=>{ try{nodes.remove(sr.id); edges.remove(`${roleId}-${sr.id}`);}catch{} });
      openedSubroles.delete(roleId);
    }

    /* ========= MONTAJES ========= */
    function mountBefore(){
      MODE = "ANTES"; applyTheme();
      clearAll();
      mountRoot(orgBefore);
      addRoles(orgBefore, orgBefore.roles);
      updateCounts();
      network.fit({animation:{duration:250}});
    }
    function mountAfter(){
      MODE = "DESPUES"; applyTheme();
      clearAll();
      mountRoot(orgAfter);
      addRoles(orgAfter, orgAfter.roles);
      updateCounts();
      network.fit({animation:{duration:250}});
    }
    function updateCounts(){
      document.getElementById("btnAntes").textContent  = `Ver ANTES (${orgBefore?.roles?.length ?? 0})`;
      document.getElementById("btnDespues").textContent = `Ver DESPUÉS (${orgAfter?.roles?.length ?? 0})`;
    }

    /* ========= CARGA DE EQUIPO (JSON) ========= */
    async function loadTeam(key){
      try{
        const res = await fetch(`data/${key}.json`);
        const data = await res.json();
        const prefix = key.toUpperCase();

        orgBefore = {
          id: `ROOT_BEFORE_${prefix}`,
          label: data.before.label || `${data.meta?.equipo || key} – ANTES`,
          roles: (data.before.roles || []).map(r => ({
            id: `${prefix}_${r.id}`,
            name: r.name,
            person: r.person || "",
            planta: !!r.planta,
            route: r.route || ""
          }))
        };

        const sub = {};
        if (data.after.subroles){
          for (const roleId in data.after.subroles){
            sub[`${prefix}_${roleId}`] = data.after.subroles[roleId].map(sr => ({
              id: `${prefix}_${sr.id}`,
              name: sr.name,
              person: sr.person || "",
              planta: !!sr.planta,
              route: sr.route || ""
            }));
          }
        }

        orgAfter = {
          id: `ROOT_AFTER_${prefix}`,
          label: data.after.label || `${data.meta?.equipo || key} – DESPUÉS`,
          roles: (data.after.roles || []).map(r => ({
            id: `${prefix}_${r.id}`,
            name: r.name,
            person: r.person || "",
            planta: !!r.planta,
            route: r.route || ""
          })),
          subroles: sub
        };

        const nice = TEAM_LABELS[key] || (data.meta?.equipo || key);
        document.getElementById("title").textContent =
          `Organigrama – ${nice}${data.meta?.titulo ? ` (${data.meta.titulo})` : ""}`;

        currentKey = key;
        document.getElementById("teamSelect").value = key;

        // por defecto vista DESPUÉS
        mountAfter();
      }catch(err){
        console.error(err);
        alert(`No pude cargar data/${key}.json`);
      }
    }

    /* ========= INTERACCIÓN ========= */
    network.on("click", (p)=>{
      if(!p.nodes.length) return;
      const id = p.nodes[0];

      if(MODE==="ANTES"){
        if(id===orgBefore.id) return toggleRoot(orgBefore, orgBefore.roles);
        const role = orgBefore.roles.find(r=>r.id===id);
        if(!role) return;
        if (currentKey === "oap" && role.route) return loadTeam(role.route); // routing desde OAP
        return togglePerson(role);
      } else {
        if(id===orgAfter.id) return toggleRoot(orgAfter, orgAfter.roles);
        const role = orgAfter.roles.find(r=>r.id===id);
        if(!role) return;
        if (currentKey === "oap" && role.route) return loadTeam(role.route); // routing desde OAP
        togglePerson(role);
        toggleSubroles(role.id, orgAfter.subroles?.[role.id]);
      }
    });

    // Selector
    const sel = document.getElementById("teamSelect");
    sel.innerHTML = TEAMS.map(k => `<option value="${k}">${TEAM_LABELS[k] || k.toUpperCase()}</option>`).join("");
    sel.value = currentKey;
    sel.addEventListener("change", e => loadTeam(e.target.value));

    // Botones
    document.getElementById("btnAntes").onclick   = ()=> mountBefore();
    document.getElementById("btnDespues").onclick = ()=> mountAfter();

    // Inicial: OAP base
    loadTeam(currentKey);
  </script>
</body>
</html>




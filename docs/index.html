<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Organigramas OAP – Antes / Después</title>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
  :root{
    /* Paleta base */
    --accent:#7c3aed;           /* púrpura (Después) */
    --accent-antes:#06b6d4;     /* cian (Antes) */
    --ink:#0f172a;
    --muted:#6b7280;
    --border:#e6e7ef;
    --bg:#ffffff;
    --appbar-bg: linear-gradient(180deg,#f6f4ff 0%, #f1effe 100%);

    --node-bg:#ffffff;
    --node-border:#d3d6e4;
    --leader-bg:#f4f1ff;
    --leader-border:#7c3aed;

    /* Drawer */
    --bar-before:var(--accent-antes);
    --bar-after:var(--accent);
    --bar-track:#eef2ff;
    --pill-active: var(--bar-after);  /* se cambia dinámicamente según modo */
  }

  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}

  header{position:sticky; top:0; z-index:10; background:var(--appbar-bg); border-bottom:1px solid var(--border)}
  .appbar{max-width:1200px; margin:0 auto; padding:18px 20px; display:flex; align-items:center; gap:24px;}
  .appbar__brand{min-width:0}
  .appbar h1{margin:0; font-size:1.28rem; line-height:1.25; font-weight:800; letter-spacing:.2px}
  .appbar .subtitle{margin:6px 0 0; color:var(--muted); font-size:.95rem}
  .appbar__controls{display:flex; align-items:center; gap:12px; flex-wrap:wrap}

  label{font-size:.92rem; color:var(--muted)}
  select{padding:9px 12px; border:1px solid #dadcee; background:#fff; border-radius:12px; cursor:pointer; font-size:.95rem; box-shadow:0 1px 0 rgba(0,0,0,.02);}

  .btn{--btn-accent: var(--accent); appearance:none; border:none; outline:none; cursor:pointer;
    padding:9px 14px; border-radius:999px; font-weight:700; font-size:.95rem;
    background:#fff; color:#111; border:1px solid #dadcee; box-shadow:0 1px 0 rgba(0,0,0,.02); transition:.18s ease;}
  .btn:hover{transform:translateY(-1px)}
  .btn.active{background:var(--btn-accent); color:#fff; border-color:var(--btn-accent); box-shadow:0 6px 16px rgba(124,58,237,.25);}

  .hintwrap{background:var(--appbar-bg); border-bottom:1px solid var(--border)}
  .hint{max-width:1200px; margin:0 auto; padding:8px 20px 16px; color:var(--muted); font-size:.95rem}

  /* Lienzo con grid sutil */
  #network{
    height:82vh;
    background:
      linear-gradient(transparent 31px,#f4f5fb 32px) repeat-y,
      linear-gradient(90deg,transparent 31px,#f4f5fb 32px) repeat-x;
    background-size:32px 32px,32px 32px;
  }

  #status{ display:none; }

  body.mode-antes  { --accent: var(--accent-antes); }
  body.mode-despues{ --accent: #7c3aed; }

  /* ===== Drawer (Resumen) ===== */
  .drawer{position:fixed; right:0; left:auto; z-index:50; pointer-events:none;}
  .drawer .sheet{
    width:420px; max-width:92vw;
    height:calc(100vh - var(--drawer-top,0px));
    background:#fff; border-left:1px solid var(--border);
    box-shadow:-18px 0 36px rgba(16,24,40,.08);
    transform:translateX(100%); transition:.24s ease; pointer-events:auto;
    display:flex; flex-direction:column; position:fixed; right:0; top:var(--drawer-top,0px);
  }
  .drawer.open .sheet{ transform:translateX(0); }

  .sheet__head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border)}
  .sheet__title{font-weight:800}
  .pill{padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; font-weight:700; cursor:pointer; user-select:none}
  .pill.active{background:var(--pill-active); border-color:var(--pill-active); color:#fff}
  .spacer{flex:1}

  .sheet__body{padding:12px; overflow:auto}
  .legend{display:flex; align-items:center; gap:10px; font-size:.9rem; color:#475569; margin:0 0 8px 2px}
  .dot{width:10px; height:10px; border-radius:999px}
  .dot.before{background:var(--bar-before)}
  .dot.after{background:var(--bar-after)}

  .row{margin:14px 0}
  .row .label{font-weight:800; margin-bottom:6px}
  .track{position:relative; height:28px; background:var(--bar-track); border-radius:8px; overflow:hidden}
  .fill{position:absolute; inset:0 auto 0 0; height:100%; display:flex; align-items:center; padding-left:8px; color:#fff; font-weight:800; font-size:.9rem}
  .fill.before{background:var(--bar-before)}
  .fill.after{background:var(--bar-after)}
  .track.compare{height:auto; background:transparent}
  .track.compare .fill{position:relative; border-radius:6px; margin:4px 0; height:26px}
  .sub{margin-left:10px; border-left:2px solid #eef2ff; padding-left:10px}

  .hr{height:1px; background:#eee; border:0; margin:12px 0 6px}
  .summary-table{width:100%; border-collapse:separate; border-spacing:0; font-size:.9rem;}
  .summary-table th, .summary-table td{border-bottom:1px solid #e9e9f3; padding:8px 10px; text-align:center; white-space:nowrap;}
  .summary-table thead th{text-align:left; position:sticky; top:0; background:#fff;}
  .summary-table .left{text-align:left}

  /* Botón para abrir/cerrar el drawer */
  .btn-small{padding:8px 12px; border-radius:12px; font-weight:700; border:1px solid var(--border); background:#fff; cursor:pointer}
</style>
</head>
<body class="mode-despues">
  <header id="appHeader">
    <div class="appbar">
      <div class="appbar__brand">
        <h1 id="title">Organigrama del equipo de la Oficina Asesora de Planeación (OAP) – <span id="year"></span></h1>
        <p class="subtitle">Presentación institucional</p>
      </div>

      <div class="appbar__controls">
        <label>Equipo:
          <select id="teamSelect"></select>
        </label>

        <button id="btnAntes" class="btn">Antes</button>
        <button id="btnDespues" class="btn active">Después</button>

        <!-- Abrir/cerrar el drawer -->
        <button id="openSummary" class="btn">Resumen</button>

        <span id="status">Listo</span>
      </div>
    </div>
    <div class="hintwrap"><div class="hint">
      Usa la <b>raíz</b> para desplegar niveles y un <b>rol</b> para ver personas y subroles. En <b>OAP</b>, al hacer clic en un equipo se abre su subdiagrama.
    </div></div>
  </header>

  <div id="network"></div>

  <!-- ===== Drawer lateral (sin X, se cierra con el botón Resumen o ESC) ===== -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="Resumen de personas">
      <div class="sheet__head">
        <span class="sheet__title">Roles por equipo</span>
        <span class="spacer"></span>

        <button id="pillAntes"    class="pill">Antes</button>
        <button id="pillDespues"  class="pill active">Después</button>
        <button id="pillComparar" class="pill">Comparar</button>
        <button id="pillSubs"     class="pill" aria-pressed="false" title="Mostrar subdivisiones">Subdividir</button>
      </div>

      <div class="sheet__body">
        <div class="legend" id="legend" style="display:none">
          <span class="dot before"></span> Antes
          <span class="dot after" style="margin-left:12px"></span> Después
        </div>
        <div id="chart"></div>

        <hr class="hr" />
        <div id="tableWrap" style="min-height:220px">
          <!-- tabla abajo -->
        </div>
      </div>
    </div>
  </aside>

<script>
/* ================== util base ================== */
document.getElementById("year").textContent = new Date().getFullYear();
const statusEl = document.getElementById("status");
function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }
window.addEventListener("error", (e)=>{ console.error(e.error || e.message); setStatus("Error: " + (e.error?.message || e.message)); });

/* ================== selección de equipo ================== */
const DATA_DIR = "data";
const TEAMS = ["oap","4p","gestion_conocimiento","administrativo","ti","mipg"];
const TEAM_LABELS = { oap:"OAP General","4p":"4P",gestion_conocimiento:"Gestión del Conocimiento",administrativo:"Administrativo",ti:"TI",mipg:"MIPG" };

const sel = document.getElementById("teamSelect");
sel.innerHTML = TEAMS.map(k=>`<option value="${k}">${TEAM_LABELS[k]||k.toUpperCase()}</option>`).join("");
sel.value = "oap";

/* ================== conteos OAP (manuales) ================== */
const OAP_MANUAL_COUNTS = {
  "ANTES": { "4p": 6, "ti": 19, "gestion_conocimiento": 3, "mipg": 8, "administrativo": 8 },
  "DESPUÉS": { "4p": 8, "ti": 20, "gestion_conocimiento": 3, "mipg": 6, "administrativo": 6 }
};
const TEAM_FIXED_COUNTS = {};

/* ================== network (sin cambios funcionales) ================== */
const LEVEL_Y_GAP = 130;
const MIN_GAP = 300;

let currentKey = "oap";
let MODE = "DESPUÉS";
let orgBefore = null, orgAfter = null;

let JEFA_LABEL = "Jefa OAP";
let JEFA_PERSON = "";
const STICKY_ID = "GLOBAL_OAP_JEFA";
let TEAM_ROOT_ID = null;

let LEADER_NODE_ID_BEFORE = null;
let LEADER_NODE_ID_AFTER  = null;

const STRATEGIST_ID = "OAP_STRATEGIST";
let STRATEGIST = null;

const SIDE_OFFSET = 220;
const JEFA_SIDE_OFFSET = 220;

const nodes = new vis.DataSet();
const edges = new vis.DataSet();
const network = new vis.Network(
  document.getElementById("network"),
  { nodes, edges },
  baseOptions()
);

network.setOptions({
  nodes:{
    chosen:{ node:(values)=>{ values.shadow=true; values.shadowSize=28; values.shadowColor="rgba(124,58,237,.20)"; values.borderWidth=2;
      values.color = values.color || {}; values.color.border = getComputedStyle(document.body).getPropertyValue('--accent').trim(); } }
  },
  edges:{ chosen:{ edge:(values)=>{ values.width=2; values.color=getComputedStyle(document.body).getPropertyValue('--accent').trim(); } } }
});

function baseOptions(){
  return {
    layout:{ hierarchical:{ enabled:true, direction:"UD", levelSeparation:LEVEL_Y_GAP, nodeSpacing:MIN_GAP, parentCentralization:true, blockShifting:false, edgeMinimization:true, sortMethod:"directed" } },
    physics:false,
    nodes:{ shape:"box", margin:10, borderWidth:1,
      color:{ background:getComputedStyle(document.body).getPropertyValue('--node-bg').trim(), border:getComputedStyle(document.body).getPropertyValue('--node-border').trim() },
      font:{ size:14, face:"system-ui, Segoe UI, Roboto, Arial, sans-serif", color:"#111827" },
      shadow:{ enabled:true, color:"rgba(0,0,0,.08)", size:20, x:0, y:6 }, shapeProperties:{ borderRadius:12 } },
    edges:{ color:{ color:'#cfd5e3', highlight:'#a7b0c6' }, width:1.2, smooth:{ enabled:true, type:"cubicBezier", forceDirection:"vertical", roundness:0.5 } },
    interaction:{ hover:true, selectable:true, dragNodes:false, zoomView:true, dragView:true, tooltipDelay:100 }
  };
}

const accent = ()=> getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#7c3aed';
const cleanPhase = (lbl='') => lbl.replace(/\s*[-–]\s*(ANTES|DESPUÉS)\s*$/i,'').replace(/\s*\((ANTES|DESPUÉS)\)\s*$/i,'').trim();
function stripTrailingCount(s){ return String(s).replace(/\s*\(\s*\d+\s*(?:roles?)?\s*\)\s*$/i,'').trim(); }
function splitTitlePerson(lbl){ if(!lbl) return {title:"", person:""}; const base=cleanPhase(lbl); const m=base.match(/^(.+?)\s*[–-]\s*(.+)$/); return m?{title:m[1].trim(), person:m[2].trim()}:{title:base, person:""}; }

function clearAll(){ nodes.clear(); edges.clear(); expandedRoot.clear(); openedPersons.clear(); openedSubroles.clear(); sidePersons.clear(); dottedArcIds.clear(); }
function mountBox(id,label,level,extra={}){ nodes.add(Object.assign({ id,label,level,shape:"box",color:{ background:"#fff", border:"#9aa3af" }, borderWidth:1 }, extra)); }
function addEdge(from,to,extra={}){ const id=`${from}-${to}`; if(!edges.get(id)) edges.add(Object.assign({ id,from,to }, extra)); return id; }
function getLevel(nodeId){ const n=nodes.get(nodeId); return (n && typeof n.level==='number')?n.level:null; }
function getSubrolesArr(data,nodeId){ return (data && data.subroles && data.subroles[nodeId]) ? data.subroles[nodeId] : null; }
function removePerson(parentId){ const pid=`${parentId}_P`; if(openedPersons.has(pid)){ try{nodes.remove(pid);}catch(_){} try{edges.remove(`${parentId}-${pid}`);}catch(_){} openedPersons.delete(pid);} }
function removeSidePerson(parentId){ const sid=`${parentId}_S`; if(sidePersons.has(sid)){ try{nodes.remove(sid);}catch(_){} try{edges.remove(`${parentId}-${sid}`);}catch(_){} sidePersons.delete(sid);} }

function closeSubtree(nodeId,data){
  const children = getSubrolesArr(data,nodeId) || [];
  children.forEach(ch => {
    closeSubtree(ch.id,data);
    removePerson(ch.id); removeSidePerson(ch.id);
    try{edges.remove(`${nodeId}-${ch.id}`);}catch(_){}
    try{nodes.remove(ch.id);}catch(_){}
    openedSubroles.delete(ch.id);
  });
  openedSubroles.delete(nodeId);
}

function applyVerticalByLevel(y0=0){ const all=nodes.get(); nodes.update(all.map(n => (typeof n.level==='number')?{id:n.id,y:y0+n.level*LEVEL_Y_GAP}:{id:n.id})); }
function childrenOf(parentId){ return edges.get({ filter:e=>e.from===parentId }).map(e=>e.to).filter(id => !!nodes.get(id)); }
function spreadChildren(parentId,gap=MIN_GAP){ const kids=childrenOf(parentId); if(kids.length<2) return;
  const p=network.getPositions([parentId])[parentId]||{x:0,y:0}; const posKids=network.getPositions(kids);
  kids.sort((a,b)=>(posKids[a]?.x||0)-(posKids[b]?.x||0)); const total=(kids.length-1)*gap; let startX=p.x-total/2;
  nodes.update(kids.map((id,i)=>({id,x:Math.round(startX+i*gap)})));
}
function applyHorizontalSpacingAll(gap=MIN_GAP){ const parents=[...new Set(edges.get().map(e=>e.from))]; parents.sort((a,b)=>((nodes.get(a)?.level||0)-(nodes.get(b)?.level||0))); parents.forEach(pid=>spreadChildren(pid,gap)); }
function fixAllPositions(fix=true){ nodes.update(nodes.get().map(n=>({id:n.id,fixed:{x:fix,y:fix}}))); }
function unfixAllPositions(){ nodes.update(nodes.get().map(n=>({id:n.id,fixed:{x:false,y:false}}))); }

const expandedRoot=new Set(); const openedPersons=new Set(); const openedSubroles=new Set(); const sidePersons=new Set(); const dottedArcIds=new Set();

function placeSidePersonFor(rootId,label,offset=SIDE_OFFSET){
  if(!label||!label.trim()) return;
  const sid=`${rootId}_S`; const rootNode=nodes.get(rootId); if(!rootNode) return;
  if(!nodes.get(sid)){
    mountBox(sid,label.trim(),rootNode.level,{ font:{ italics:true }, color:{ background:"#f8fafc", border:"#d1d5db" }, shapeProperties:{ borderRadius:999 } });
    addEdge(rootId,sid,{ dashes:true, arrows:'to', smooth:{ enabled:true, type:'horizontal', forceDirection:'vertical' } });
    sidePersons.add(sid);
  }
  const r=network.getPositions([rootId])[rootId]||{x:0,y:0};
  nodes.update({ id:sid,x:r.x+offset,y:r.y,level:rootNode.level,fixed:{x:true,y:true} });
}
function keepSideAligned(rootId,offset=SIDE_OFFSET){ const sid=`${rootId}_S`; if(!nodes.get(sid)||!nodes.get(rootId)) return; const r=network.getPositions([rootId])[rootId]; const level=getLevel(rootId)??0; nodes.update({id:sid,x:r.x+offset,y:r.y,level}); }
function placeSidePersonForJefa(rootId){ placeSidePersonFor(rootId,JEFA_PERSON,JEFA_SIDE_OFFSET); }
function keepJefaPersonSideAlignedFor(rootId){ keepSideAligned(rootId,JEFA_SIDE_OFFSET); }

function clearDottedArcs(){ dottedArcIds.forEach(id=>{ try{edges.remove(id);}catch(_){}}); dottedArcIds.clear(); }
function buildDottedArcsToTeams(roles){
  clearDottedArcs();
  if(!STRATEGIST || !STRATEGIST.label || !nodes.get(STRATEGIST_ID)) return;
  (roles||[]).forEach(r=>{
    if(!nodes.get(r.id)) return;
    const id=`DOT_${STRATEGIST_ID}_${r.id}`;
    edges.add({ id,from:STRATEGIST_ID,to:r.id,dashes:true,arrows:'', color:{color:'#9aa3b2'}, width:1.6,
      smooth:{enabled:true,type:'horizontal',forceDirection:'vertical',roundness:0.35}});
    dottedArcIds.add(id);
  });
}

/* ====== AJUSTE ZOOM: mantener vista cuando corresponde ====== */
function stabilizeAndFit(anim = 200, viewToRestore = null){
  setStatus("Ajustando layout…");
  unfixAllPositions();
  applyVerticalByLevel(0);

  setTimeout(() => {
    applyHorizontalSpacingAll(MIN_GAP);

    if (currentKey === 'oap'){
      if (nodes.get(orgAfter?.id || orgBefore?.id)) {
        nodes.update({ id:(MODE==="ANTES"?orgBefore.id:orgAfter.id), x: 0 });
      }
      if (nodes.get(STRATEGIST_ID)) { nodes.update({ id: STRATEGIST_ID, x: 0 }); }
      keepJefaPersonSideAlignedFor((MODE==="ANTES") ? orgBefore.id : orgAfter.id);
      if (nodes.get(STRATEGIST_ID)) keepSideAligned(STRATEGIST_ID, SIDE_OFFSET);
    }

    setTimeout(() => {
      fixAllPositions(true);

      if (viewToRestore){
        network.moveTo({
          position: viewToRestore.position,
          scale: viewToRestore.scale,
          animation: { duration: anim, easingFunction:"easeInOutQuad" }
        });
      } else {
        network.fit({ animation:{ duration: anim, easingFunction:"easeInOutQuad" } });
      }

      setStatus("Listo");
    }, 0);
  }, 0);
}

function captureView(){
  return {
    position: network.getViewPosition(),
    scale: network.getScale()
  };
}
function refreshKeepingZoom(anim = 120){
  const view = captureView();
  stabilizeAndFit(anim, view);
}

/* ====== FIN zoom ====== */

function togglePersonNode(roleId,personLabel,levelIfUnknown,planta=false){
  const label=(personLabel||"").trim(); if(!label) return;
  const pid=`${roleId}_P`;
  if(openedPersons.has(pid)){ try{nodes.remove(pid);}catch(_){ } try{edges.remove(`${roleId}-${pid}`);}catch(_){ } openedPersons.delete(pid); return; }
  const roleLevel=getLevel(roleId); const personLevel=(roleLevel!=null?roleLevel+1:(levelIfUnknown||3));
  const extra={ font:{ italics:true } }; if(planta) extra.color={ background:"#efe9ff", border:"#7a5cff" };
  mountBox(pid,label,personLevel,extra); addEdge(roleId,pid); openedPersons.add(pid);
}

function toggleSubroles(roleId,subrolesArr,dataCtx){
  if(!subrolesArr || !subrolesArr.length) return;
  if(openedSubroles.has(roleId)){
    subrolesArr.forEach(sr=>{ const rid=sr.id, pid=`${rid}_P`; try{nodes.remove(pid);}catch(_){ } try{edges.remove(`${rid}-${pid}`);}catch(_){ } try{nodes.remove(rid);}catch(_){ } try{edges.remove(`${roleId}-${rid}`);}catch(_){ } openedPersons.delete(pid); });
    openedSubroles.delete(roleId); return;
  }
  const roleLevel=getLevel(roleId)??3;
  const CURRENT_LEADER_ID=(MODE==="ANTES")?LEADER_NODE_ID_BEFORE:LEADER_NODE_ID_AFTER;
  const isLeaderParent=(CURRENT_LEADER_ID && roleId===CURRENT_LEADER_ID);
  const subLevel=roleLevel+(isLeaderParent?2:1); const personLevel=subLevel+1;

  subrolesArr.forEach(sr=>{
    mountBox(sr.id,sr.name,subLevel); addEdge(roleId,sr.id);
    const hasGrandkids=!!getSubrolesArr(dataCtx,sr.id)?.length; const personText=(sr.person||"").trim();
    if(personText){ mountBox(`${sr.id}_P`,personText,personLevel,{font:{italics:true}}); addEdge(sr.id,`${sr.id}_P`); openedPersons.add(`${sr.id}_P`); }
    else if(!hasGrandkids){ mountBox(`${sr.id}_P`,"Nuevo perfil",personLevel,{font:{italics:true}}); addEdge(sr.id,`${sr.id}_P`); openedPersons.add(`${sr.id}_P`); }
  });
  openedSubroles.add(roleId);
}

function rewireUnderLeaderIfAny(rootId,roles,leaderIdFromMeta){
  let leaderId=leaderIdFromMeta||null; if(!leaderId){ const cand=roles.find(r=>/^\s*l[ií]der\s*$/i.test(r.name)); leaderId=cand?.id||null; }
  if(!leaderId || !nodes.get(leaderId)) return;
  const base=getLevel(rootId)??0;
  nodes.update({id:leaderId, level:base+1});
  roles.forEach(r=>{ if(r.id===leaderId) return; try{edges.remove(`${rootId}-${r.id}`);}catch(_){ } addEdge(leaderId,r.id); nodes.update({id:r.id, level:base+2}); });
}

function refreshButtons(){
  const a=document.getElementById("btnAntes"); const d=document.getElementById("btnDespues");
  a.classList.toggle("active", MODE==="ANTES"); d.classList.toggle("active", MODE==="DESPUÉS");
  document.body.classList.toggle("mode-antes",   MODE==="ANTES");
  document.body.classList.toggle("mode-despues", MODE==="DESPUÉS");
  a.style.setProperty("--btn-accent","var(--accent)"); d.style.setProperty("--btn-accent","var(--accent)");
}

function updateCountsUI(){}

async function enrichCountsForOAP(roles){
  if(currentKey!=="oap" || !roles) return;
  const modeKey=(MODE==="ANTES")?"ANTES":"DESPUÉS";
  for(const r of (roles||[])){
    const baseLabel=stripTrailingCount(r.name);
    const routeKey=(r.route||"").trim();
    const manual=routeKey? OAP_MANUAL_COUNTS[modeKey]?.[routeKey] : undefined;
    if(typeof manual==="number"){ nodes.update({ id:r.id, label:`${baseLabel} (${manual} roles)` }); }
    else { nodes.update({ id:r.id, label:baseLabel }); }
  }
  buildDottedArcsToTeams(roles);
}

function baseNetworkOptions(){ network.setOptions(baseOptions()); }

function mountOAP(view="DESPUÉS"){
  MODE=view; clearAll(); baseNetworkOptions(); refreshButtons();
  const data=(view==="ANTES")?orgBefore:orgAfter;
  const {title,person}=splitTitlePerson(data.label); JEFA_LABEL=title||JEFA_LABEL; if(person) JEFA_PERSON=person;
  mountBox(data.id,JEFA_LABEL,0,{ color:{ background:"#fff", border:accent() }, borderWidth:2 }); nodes.update({id:data.id, x:0});
  const hasStrategist=!!(STRATEGIST && STRATEGIST.label);
  if(hasStrategist){ mountBox(STRATEGIST_ID,STRATEGIST.label,1); addEdge(data.id,STRATEGIST_ID); nodes.update({id:STRATEGIST_ID,x:0}); }
  const levelTeams=hasStrategist?2:1;
  (data.roles||[]).forEach(r=>{ mountBox(r.id,r.name,levelTeams); addEdge(data.id,r.id); });
  updateCountsUI(); enrichCountsForOAP(data.roles); stabilizeAndFit(160); /* fit en cambio grande */
}

function addCountsToNodes(data,overrides){
  if(!data || !data.subroles) return;
  for(const parentId in data.subroles){
    const node=nodes.get(parentId); if(!node) continue;
    const base=stripTrailingCount(node.label||"");
    const nOverride=overrides && overrides[base];
    const n=(nOverride!=null)?nOverride:data.subroles[parentId].length;
    nodes.update({ id:parentId, label:`${base} (${n} roles)` });
  }
}

function mountTeam(view="DESPUÉS"){
  MODE=view; baseNetworkOptions(); refreshButtons();
  clearAll(); try{nodes.remove(STICKY_ID);}catch(_){}
  try{ edges.get().forEach(e=>{ if(e.from===STICKY_ID || e.to===STICKY_ID) edges.remove(e.id); }); }catch(_){}
  const data=(view==="ANTES")?orgBefore:orgAfter;
  TEAM_ROOT_ID=`TEAM_${currentKey.toUpperCase()}`; mountBox(TEAM_ROOT_ID,cleanPhase(data.label),0);
  (data.roles||[]).forEach(r=>{ mountBox(r.id,r.name,1); addEdge(TEAM_ROOT_ID,r.id); });
  const CURRENT_LEADER_ID=(MODE==="ANTES")?LEADER_NODE_ID_BEFORE:LEADER_NODE_ID_AFTER;
  rewireUnderLeaderIfAny(TEAM_ROOT_ID,data.roles,CURRENT_LEADER_ID);
  if(CURRENT_LEADER_ID && nodes.get(CURRENT_LEADER_ID)){
    nodes.update({ id:CURRENT_LEADER_ID, color:{background:getComputedStyle(document.body).getPropertyValue('--leader-bg').trim(), border:getComputedStyle(document.body).getPropertyValue('--leader-border').trim()}, font:{bold:true} });
  }
  const teamOverrides=(TEAM_FIXED_COUNTS[currentKey] && TEAM_FIXED_COUNTS[currentKey][(MODE==="ANTES")?"ANTES":"DESPUÉS"]) || null;
  addCountsToNodes(data,teamOverrides);
  updateCountsUI(); stabilizeAndFit(160); /* fit en cambio grande */
}

async function loadTeam(key){
  setStatus("Cargando…");
  try{
    const res = await fetch(`${DATA_DIR}/${key}.json?cb=${Date.now()}`); const data = await res.json(); const prefix=key.toUpperCase();
    function mapRoles(block){ return (block.roles||[]).map(r=>({ id:`${prefix}_${r.id}`, name:r.name, person:r.person||"", planta:!!r.planta, route:r.route||"" })); }
    function mapSubroles(block){ const out={}; if(block.subroles){ for(const roleId in block.subroles){ out[`${prefix}_${roleId}`]=block.subroles[roleId].map(sr=>({ id:`${prefix}_${sr.id}`, name:sr.name, person:sr.person||"", planta:!!sr.planta })); } } return out; }

    LEADER_NODE_ID_BEFORE = data.meta?.leaderIdBefore ? `${prefix}_${data.meta.leaderIdBefore}` : null;
    LEADER_NODE_ID_AFTER  = data.meta?.leaderIdAfter  ? `${prefix}_${data.meta.leaderIdAfter}`  : null;
    if(data.meta?.leaderId){ const fb=`${prefix}_${data.meta.leaderId}`; if(!LEADER_NODE_ID_BEFORE) LEADER_NODE_ID_BEFORE=fb; if(!LEADER_NODE_ID_AFTER) LEADER_NODE_ID_AFTER=fb; }

    STRATEGIST = data.meta?.strategist ? { label:(data.meta.strategist.label||"").trim(), person:(data.meta.strategist.person||"").trim() } : null;

    orgBefore = { id:`ROOT_BEFORE_${prefix}`, label:data.before.label || `${data.meta?.equipo||key} – ANTES`,  roles:mapRoles(data.before), subroles:mapSubroles(data.before) };
    orgAfter  = { id:`ROOT_AFTER_${prefix}`,  label:data.after.label  || `${data.meta?.equipo||key} – DESPUÉS`, roles:mapRoles(data.after),  subroles:mapSubroles(data.after) };

    if(key==="oap"){ const {title,person}=splitTitlePerson(orgAfter.label); if(title) JEFA_LABEL=cleanPhase(title); if(person) JEFA_PERSON=person; }

    document.getElementById("title").innerHTML = `Organigrama del equipo de la Oficina Asesora de Planeación (OAP) – <span id="year">${new Date().getFullYear()}</span>`;

    currentKey=key; sel.value=key;
    if(key==="oap") mountOAP("DESPUÉS"); else mountTeam("DESPUÉS");
    setStatus("Listo");

    if(drawerOpen) { await ensureResumen(); renderResumen(); }
  }catch(err){ console.error(err); setStatus("Error al cargar"); alert(`No pude cargar ${DATA_DIR}/${key}.json`); }
}

/* -------- Interacción grafo -------- */
network.on("click",(p)=>{
  if(!p.nodes.length) return;
  const id=p.nodes[0];

  if(currentKey==="oap"){
    const data=(MODE==="ANTES")?orgBefore:orgAfter;

    if(id===data.id){
      const sid=`${data.id}_S`;
      if(sidePersons.has(sid)){ removeSidePerson(data.id); } else { placeSidePersonForJefa(data.id); }
      if(expandedRoot.has(data.id)){
        (data.roles||[]).forEach(r=>{ closeSubtree(r.id,data); removePerson(r.id); removeSidePerson(r.id); try{edges.remove(`${data.id}-${r.id}`);}catch(_){ } try{nodes.remove(r.id);}catch(_){ } });
        if(nodes.get(STRATEGIST_ID)){ removePerson(STRATEGIST_ID); try{edges.remove(`${data.id}-${STRATEGIST_ID}`);}catch(_){ } try{nodes.remove(STRATEGIST_ID);}catch(_){ } }
        clearDottedArcs(); expandedRoot.delete(data.id);
      }else{
        if(STRATEGIST && STRATEGIST.label && !nodes.get(STRATEGIST_ID)){ mountBox(STRATEGIST_ID,STRATEGIST.label,1); addEdge(data.id,STRATEGIST_ID); nodes.update({id:STRATEGIST_ID,x:0}); }
        const levelTeams=(STRATEGIST && STRATEGIST.label)?2:1;
        (data.roles||[]).forEach(r=>{ if(!nodes.get(r.id)) mountBox(r.id,r.name,levelTeams); addEdge(data.id,r.id); });
        buildDottedArcsToTeams(data.roles); expandedRoot.add(data.id);
      }
      refreshKeepingZoom(120); return;
    }

    if(id===STRATEGIST_ID){ togglePersonNode(STRATEGIST_ID,STRATEGIST?.person||"",2,false); nodes.update({id:STRATEGIST_ID,x:0}); refreshKeepingZoom(120); return; }

    const role=(data.roles||[]).find(r=>r.id===id);
    if(role && role.route){ loadTeam(role.route); return; }
    if(role && !role.route){ togglePersonNode(role.id,role.person,3,!!role.planta); refreshKeepingZoom(120); }
    return;
  }

  // vista equipo
  const data=(MODE==="ANTES")?orgBefore:orgAfter;

  if(id===TEAM_ROOT_ID){
    if(expandedRoot.has(TEAM_ROOT_ID)){
      (data.roles||[]).forEach(r=>{ closeSubtree(r.id,data); removePerson(r.id); removeSidePerson(r.id); try{edges.remove(`${TEAM_ROOT_ID}-${r.id}`);}catch(_){ } try{nodes.remove(r.id);}catch(_){ } });
      expandedRoot.delete(TEAM_ROOT_ID);
    }else{
      (data.roles||[]).forEach(r=>{ if(!nodes.get(r.id)) mountBox(r.id,r.name,1); addEdge(TEAM_ROOT_ID,r.id); });
      const CURRENT_LEADER_ID=(MODE==="ANTES")?LEADER_NODE_ID_BEFORE:LEADER_NODE_ID_AFTER;
      rewireUnderLeaderIfAny(TEAM_ROOT_ID,data.roles,CURRENT_LEADER_ID);
      expandedRoot.add(TEAM_ROOT_ID);
    }
    refreshKeepingZoom(120); return;
  }

  const role=(data.roles||[]).find(r=>r.id===id);
  if(role){
    const CURRENT_LEADER_ID=(MODE==="ANTES")?LEADER_NODE_ID_BEFORE:LEADER_NODE_ID_AFTER;
    if(role.id===CURRENT_LEADER_ID){
      const sid=`${role.id}_S`;
      if(sidePersons.has(sid)){ removeSidePerson(role.id); }
      else { placeSidePersonFor(role.id,(role.person||"Nuevo perfil"),SIDE_OFFSET); }
      const arr=data.subroles?.[role.id]; if(arr && arr.length) toggleSubroles(role.id,arr,data);
    }else{
      togglePersonNode(role.id,role.person,3,!!role.planta);
      const arr=data.subroles?.[role.id]; if(arr && arr.length) toggleSubroles(role.id,arr,data);
    }
    refreshKeepingZoom(120); return;
  }

  const nested=getSubrolesArr(data,id);
  if(nested && nested.length){ toggleSubroles(id,nested,data); refreshKeepingZoom(120); return; }
});

/* ======== Drawer: Resumen ======== */
let resumenData=null;
let drawerOpen=false;
let resumenMode='DESPUÉS'; // 'ANTES' | 'DESPUÉS' | 'COMPARAR'
let includeSubs=false;      // por defecto sin subdividir

async function ensureResumen(){
  if(resumenData) return resumenData;
  const res=await fetch(`${DATA_DIR}/resumen.json?cb=${Date.now()}`);
  resumenData=await res.json();
  return resumenData;
}

/* posiciona el drawer bajo el header */
function positionDrawer(){
  const header = document.getElementById('appHeader');
  const top = header.getBoundingClientRect().height;
  document.documentElement.style.setProperty('--drawer-top', `${top}px`);
}

function setPillColor(){
  const root = document.documentElement;
  if(resumenMode==='ANTES') root.style.setProperty('--pill-active', 'var(--bar-before)');
  else if(resumenMode==='DESPUÉS') root.style.setProperty('--pill-active', 'var(--bar-after)');
  else root.style.setProperty('--pill-active', 'var(--bar-after)'); /* comparar: deja morado */
}

function togglePillsUI(){
  document.getElementById('pillAntes').classList.toggle('active', resumenMode==='ANTES');
  document.getElementById('pillDespues').classList.toggle('active', resumenMode==='DESPUÉS');
  document.getElementById('pillComparar').classList.toggle('active', resumenMode==='COMPARAR');
  document.getElementById('legend').style.display = (resumenMode==='COMPARAR') ? 'flex' : 'none';
  setPillColor();
}

function rowsForScope(){
  const keys = (currentKey==='oap') ? ['4p','ti','gestion_conocimiento','mipg','administrativo'] : [currentKey];
  const rows=[];
  keys.forEach(k=>{
    const e=resumenData.equipos[k]; if(!e) return;
    rows.push({ label:e.label||k, a:e.antes?.total||0, d:e.despues?.total||0, isGroup:true, subs:e.subdivisiones||[] });
    if(includeSubs && Array.isArray(e.subdivisiones)){
      e.subdivisiones.forEach(s=> rows.push({ label:"• "+s.label, a:s.antes||0, d:s.despues||0, isGroup:false, isSub:true }));
    }
  });
  return rows;
}

function renderResumen(){
  if(!resumenData) return;
  const chart=document.getElementById('chart');
  const tableWrap=document.getElementById('tableWrap');

  const rows = rowsForScope();
  const maxVal = Math.max(...rows.map(r => Math.max(r.a, r.d, 1)));

  // BARRAS (solo números)
  let out='';
  rows.forEach(r=>{
    const cls = r.isSub ? 'row sub' : 'row';
    const aw = Math.round((r.a/maxVal)*100);
    const dw = Math.round((r.d/maxVal)*100);
    const oneMode = (resumenMode!=='COMPARAR');
    out += `<div class="${cls}">
      <div class="label">${r.label}</div>
      ${oneMode
        ? `<div class="track">
             <div class="fill ${resumenMode==='ANTES'?'before':'after'}" style="width:${resumenMode==='ANTES'?aw:dw}%">
               <span>${resumenMode==='ANTES'?r.a:r.d}</span>
             </div>
           </div>`
        : `<div class="track compare">
             <div class="fill before" style="width:${aw}%">${r.a}</div>
             <div class="fill after"  style="width:${dw}%">${r.d}</div>
           </div>`}
    </div>`;
  });
  chart.innerHTML = out;

  // TABLA INFERIOR + TOTALES (suma solo filas de grupo para no duplicar al incluir subdivisiones)
  let th = (resumenMode==='COMPARAR')
            ? `<th>Antes</th><th>Después</th>`
            : `<th>${resumenMode==='ANTES'?'Antes':'Después'}</th>`;

  let totalA = 0, totalD = 0;
  let tbody='';
  rows.forEach(r=>{
    if(r.isGroup){ totalA += Number(r.a||0); totalD += Number(r.d||0); }
    tbody += `<tr>
      <td class="left">${r.label}</td>
      ${resumenMode==='COMPARAR'
        ? `<td>${r.a}</td><td>${r.d}</td>`
        : `<td>${resumenMode==='ANTES'?r.a:r.d}</td>`}
    </tr>`;
  });

  const tfoot = (resumenMode==='COMPARAR')
    ? `<tr><th class="left">Total</th><th>${totalA}</th><th>${totalD}</th></tr>`
    : `<tr><th class="left">Total</th><th>${resumenMode==='ANTES'?totalA:totalD}</th></tr>`;

  tableWrap.innerHTML = `
    <table class="summary-table">
      <thead>
        <tr><th class="left">Equipos / subdivisiones</th>${th}</tr>
      </thead>
      <tbody>${tbody}</tbody>
      <tfoot>${tfoot}</tfoot>
    </table>`;
}

/* abrir/cerrar (toggle con el mismo botón Resumen) */
const drawer = document.getElementById('drawer');
function openDrawer(){
  positionDrawer();
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawerOpen=true;
}
function closeDrawer(){
  drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); drawerOpen=false;
}

document.getElementById('openSummary').addEventListener('click', async ()=>{
  if(drawerOpen){ closeDrawer(); return; }
  openDrawer();
  await ensureResumen();
  togglePillsUI();
  renderResumen();
});
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && drawerOpen) closeDrawer(); });
window.addEventListener('resize', ()=>{ if(drawerOpen) positionDrawer(); });

/* controles del drawer */
document.getElementById('pillAntes').addEventListener('click', ()=>{ resumenMode='ANTES'; togglePillsUI(); renderResumen(); });
document.getElementById('pillDespues').addEventListener('click', ()=>{ resumenMode='DESPUÉS'; togglePillsUI(); renderResumen(); });
document.getElementById('pillComparar').addEventListener('click', ()=>{ resumenMode='COMPARAR'; togglePillsUI(); renderResumen(); });

const pillSubs = document.getElementById('pillSubs');
pillSubs.addEventListener('click', ()=>{
  includeSubs = !includeSubs;
  pillSubs.classList.toggle('active', includeSubs);
  pillSubs.setAttribute('aria-pressed', includeSubs ? 'true' : 'false');
  renderResumen();
});

/* ======== cambios de equipo / modo ======== */
sel.addEventListener("change", async e=>{ await loadTeam(e.target.value); if(drawerOpen){ await ensureResumen(); renderResumen(); } });
document.getElementById("btnAntes").onclick   = ()=>{ if(currentKey==="oap") mountOAP("ANTES"); else mountTeam("ANTES"); };
document.getElementById("btnDespues").onclick = ()=>{ if(currentKey==="oap") mountOAP("DESPUÉS"); else mountTeam("DESPUÉS"); };

/* ===== carga inicial ===== */
loadTeam("oap");
</script>
</body>
</html>




